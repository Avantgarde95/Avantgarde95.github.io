<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"/><link href="https://fonts.cdnfonts.com/css/sf-mono" rel="stylesheet"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-d25b0b66ce6f2c89.js" defer=""></script><script src="/_next/static/chunks/framework-f706abb83a373953.js" defer=""></script><script src="/_next/static/chunks/main-91ba3640eeeaf792.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad1b355fa9795f7d.js" defer=""></script><script src="/_next/static/chunks/963-fe4341fa4536f0db.js" defer=""></script><script src="/_next/static/chunks/47-66d48d1b8dda9d70.js" defer=""></script><script src="/_next/static/chunks/pages/blog/post/%5Bkey%5D-f14ada5fb7527a52.js" defer=""></script><script src="/_next/static/YFQecxITs5IjSo3NXKcxk/_buildManifest.js" defer=""></script><script src="/_next/static/YFQecxITs5IjSo3NXKcxk/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global iftqeq">html{width:100%;height:100%;margin:0;padding:0;font-family:"Pretendard",sans-serif;font-size:62.5%;}body{width:100%;height:100%;margin:0;padding:0;}#__next{width:100%;height:100%;}</style><style data-emotion="css d80h7l">.css-d80h7l{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;box-sizing:border-box;width:100%;height:100%;padding-top:8px;color:#1f1f1f;background-color:#ffffff;}</style><div class="css-d80h7l eaogay90"><style data-emotion="css 134o37c">.css-134o37c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;max-width:1000px;}</style><div class="css-134o37c eaogay91"><style data-emotion="css 1plrt3">.css-1plrt3{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;width:100%;padding:18px 20px;}</style><header class="css-1plrt3 eb4s6i10"><style data-emotion="css 6yt065">.css-6yt065{cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}</style><style data-emotion="css qew31m">.css-qew31m{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}.css-qew31m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-qew31m:hover{background-color:transparent;}}.css-qew31m.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css ek6cv0">.css-ek6cv0{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}.css-ek6cv0::-moz-focus-inner{border-style:none;}.css-ek6cv0.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-ek6cv0{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-ek6cv0:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-ek6cv0:hover{background-color:transparent;}}.css-ek6cv0.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium css-ek6cv0" tabindex="0" type="button"><svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18M3 12h18M3 6h18" stroke="#1F1F1F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><style data-emotion="css a3xyjy">.css-a3xyjy{z-index:1200;}</style><style data-emotion="css 1ogcupm animation-c9pehb">.css-1ogcupm{margin:0;padding:0;text-align:center;-webkit-flex:1;-ms-flex:1;flex:1;font-size:21px;font-weight:700;opacity:0;-webkit-animation:animation-c9pehb 0.5s forwards;animation:animation-c9pehb 0.5s forwards;}@-webkit-keyframes animation-c9pehb{100%{opacity:1;}}@keyframes animation-c9pehb{100%{opacity:1;}}</style><h1 class="css-1ogcupm eb4s6i11">블로그</h1><style data-emotion="css jtr702">.css-jtr702{cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}</style><style data-emotion="css 10p1af">.css-10p1af{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}.css-10p1af:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-10p1af:hover{background-color:transparent;}}.css-10p1af.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css 148js05">.css-148js05{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}.css-148js05::-moz-focus-inner{border-style:none;}.css-148js05.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-148js05{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-148js05:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-148js05:hover{background-color:transparent;}}.css-148js05.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium css-148js05" tabindex="0" type="button"><style data-emotion="css 1i0bw9d">.css-1i0bw9d{font-size:21px;line-height:21px;opacity:1;-webkit-transition:opacity 1s,font-size 0.3s,line-height 0.3s;transition:opacity 1s,font-size 0.3s,line-height 0.3s;}</style><span class="css-1i0bw9d">가</span><style data-emotion="css bah3n2">.css-bah3n2{font-size:12px;line-height:12px;opacity:0.5;-webkit-transition:opacity 1s,font-size 0.3s,line-height 0.3s;transition:opacity 1s,font-size 0.3s,line-height 0.3s;}</style><span class="css-bah3n2">A</span></button></header><style data-emotion="css 1kxong4">.css-1kxong4{overflow-y:auto;width:100%;-webkit-flex:1;-ms-flex:1;flex:1;}</style><main class="css-1kxong4 eaogay92"><style data-emotion="css 1jldanx">.css-1jldanx{box-sizing:border-box;width:100%;padding:0 21px;}</style><div class="css-1jldanx eykyrpm2"><style data-emotion="css 1rr6krv">.css-1rr6krv{margin-bottom:2px;font-size:20px;font-weight:bold;}</style><div class="css-1rr6krv eykyrpm3">Server &amp; client mismatch problem in Next.js</div><style data-emotion="css 4osezd">.css-4osezd{margin-bottom:16px;font-size:16px;}</style><div class="css-4osezd eykyrpm4">2022-09-21</div><style data-emotion="css yar54t">.css-yar54t{word-break:break-all;width:100%;margin-bottom:8px;font-size:16px;border-top:1px solid #818181;border-bottom:1px solid #818181;}.css-yar54t h1{font-size:20px;}.css-yar54t h2{font-size:18px;}.css-yar54t h3{font-size:16px;}.css-yar54t ul{padding-left:24px;}.css-yar54t a{cursor:pointer;font-weight:normal;color:#3c4fff;}.css-yar54t table{box-sizing:border-box;border-collapse:collapse;border:1px solid #818181;}.css-yar54t table th,.css-yar54t table td{box-sizing:border-box;padding:8px;border:1px solid #818181;}.css-yar54t code{font-family:"SF Mono",monospace!important;}</style><div class="css-yar54t eykyrpm5"><p>이 웹사이트를 실행했을 때, 작동은 잘 되는 것 같은데 콘솔에 아래와 같은 에러 메시지들이 뜨는 문제가 있었다.</p>
<p>When I run this website, it seems to work fine, but I got following error messages appearing on the console.</p>
<pre><style data-emotion="css femo2h">.css-femo2h{box-sizing:border-box;vertical-align:middle;font-size:13px;padding:0 2px;line-height:16px;background-color:rgba(232,232,232,0.7);}</style><code class="language-text css-femo2h eykyrpm0">Uncaught Error: Minified React error #425; visit https://reactjs.org/docs/error-decoder.html?invariant=425 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.

Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.

Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
</code></pre>
<p>위 에러 메시지들에 나온 링크를 방문해보면 아래와 같은 메시지들이 나온다.</p>
<p>If you visit the links in these error messages, you will see the following messages.</p>
<ul>
<li>Text content does not match server-rendered HTML.</li>
<li>Hydration failed because the initial UI does not match what was rendered on the server.</li>
<li>There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.</li>
</ul>
<p>이 웹사이트는 Next.js로 정적 사이트 생성(SSG - Static Site Generation)을 하여 만들었다.
Next.js로 미리 생성한 HTML을 일단 유저에게 보여주고, 그 후에 React로 hydration &amp; CSR(Client-side Rendering)을 하는 방식이다.
따라서, 위의 메시지들은 미리 렌더링한 HTML과 클라이언트에서 렌더링한 HTML 간에 내용물이 불일치한다는 것을 의미한다.
이 문제는 SSR 뿐만 아니라 SSR 상황에서도 동일하게 발생한다.</p>
<p>I created this website by using SSG (Static Site Generation) with Next.js
It works by showing the pre-generated HTML to the user first, and performing hydration &amp; CSR (Client-side Rendering) with React.
Therefore, the above messages mean that there is a content mismatch between the pre-rendered HTML and the client-rendered HTML.
This problem can occur not only SSG but also SSR, too.</p>
<p>원인은 두 곳에 있었다.
하나는 페이지 상단의 시계 UI이다.</p>
<p>There were two reasons.
One is the clock UI at the top of the page.</p>
<pre><code class="language-typescript css-femo2h eykyrpm0">import { useEffect, useState } from &quot;react&quot;;

export default function useNow() {
  const [now, setNow] = useState(new Date());

  useEffect(() =&gt; {
    const interval = setInterval(() =&gt; {
      setNow(new Date());
    }, 1000 * 10);

    return () =&gt; {
      clearInterval(interval);
    };
  }, []);

  return {
    year: now.getFullYear(),
    month: now.getMonth() + 1,
    monthDay: now.getDate(),
    hour: now.getHours(),
    minute: now.getMinutes(),
    second: now.getSeconds(),
  };
}
</code></pre>
<p>시계 기능을 구현하기 위해 위와 같은 custom hook을 작성했었다.
그런데 <code class="css-femo2h eykyrpm0">const [now, setNow] = useState(new Date());</code>에서 <code class="css-femo2h eykyrpm0">new Date()</code>의 값은 서버 렌더링 시와, 클라이언트 렌더링 시에 <strong>서로 다르다</strong>.
이로 인하여 시계 텍스트가 두 상황에서 불일치하여 에러가 났던 것이다.
CSR 전까지는 실제 시간을 사용하지 않고 더미 값을 쓰도록 하여 해결하였다.</p>
<p>I wrote the above custom hook to implement the clock.
However, in <code class="css-femo2h eykyrpm0">const [now, setNow] = useState(new Date());</code>, the value of <code class="css-femo2h eykyrpm0">new Date()</code> is <strong>different</strong> between server rendering and client rendering.
This inconsistency of the clock text caused the error.
I solved this problem by using a dummy value until we perform CSR.</p>
<p>다만 이러면 초반에 시간이 더미 값으로 떠서 이상해 보이는 문제가 있다.
적절한 로딩 UI를 부여하면 좀 낫지 않을까 한다.</p>
<p>However, we get a problem that the user sees a dummy value at the beginning.
We may fix that problem by using appropriate loading UI.</p>
<pre><code class="language-typescript css-femo2h eykyrpm0">import { useEffect, useState } from &quot;react&quot;;

interface Time {
  year: number;
  month: number;
  monthDay: number;
  hour: number;
  minute: number;
  second: number;
}

export default function useNow(): Time {
  // If we use new Date() at here, server HTML and client HTML won&#x27;t match.
  // So we don&#x27;t compute date before useEffect().
  const [now, setNow] = useState&lt;Date | null&gt;(null);

  useEffect(() =&gt; {
    setNow(new Date());

    const interval = setInterval(() =&gt; {
      setNow(new Date());
    }, 1000 * 10);

    return () =&gt; {
      clearInterval(interval);
    };
  }, []);

  return now === null
    ? {
        year: 0,
        month: 0,
        monthDay: 0,
        hour: 0,
        minute: 0,
        second: 0,
      }
    : {
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        monthDay: now.getDate(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        second: now.getSeconds(),
      };
}
</code></pre>
<p>다른 하나는 이 글처럼 코드를 렌더링 할 때 쓰는 react-syntax-highlighter 라이브러리이다.
해당 라이브러리는 내부적으로 <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">Prism.js</a>(또는 <a target="_blank" rel="noreferrer noopener" href="https://highlightjs.org/">highlight.js</a>)를 호출한다.
이들은 코드를 읽고 <strong>DOM을 변경</strong>하여 코드 하이라이팅을 한다.
이것이 mismatch를 만들어낸 것으로 추정한다.</p>
<p>이와 같은 상황에서 특정 동작을 클라이언트에서만 하도록 하고 싶으면, <code class="css-femo2h eykyrpm0">useEffect()</code>를 활용할 수 있다.
<code class="css-femo2h eykyrpm0">useEffect()</code> 안의 코드는 항상 <strong>클라이언트에서만 실행</strong>된다.
<code class="css-femo2h eykyrpm0">useEffect()</code>가 처음 불리는 시점은 컴포넌트가 마운트된 이후, 즉 DOM이 생성된 이후이기 때문이다.</p>
<p>The other is the react-syntax-highlighter library used when rendering code like this article.
The library calls <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">Prism.js</a> (or <a target="_blank" rel="noreferrer noopener" href="https://highlightjs.org/">highlight.js</a>) internally.
They read the code and <strong>change the DOM</strong> to highlight the code.
It seems that that behavior created mismatches.</p>
<p>In such a situation, if you want to make certain actions executed only for the client, you can use <code class="css-femo2h eykyrpm0">useEffect()</code>.
Code in <code class="css-femo2h eykyrpm0">useEffect()</code> is always executed <strong>only on the client</strong>.
This is because the first time <code class="css-femo2h eykyrpm0">useEffect()</code> is called is after the component is mounted i.e after the DOM is created.</p>
<p>우선 아래와 같은 custom hook을 하나 만들었다.
<code class="css-femo2h eykyrpm0">isClient</code>는 클라이언트에서만 true이 된다.</p>
<p>I created the following custom hook first.
<code class="css-femo2h eykyrpm0">isClient</code> can be true only on the client.</p>
<pre><code class="language-typescript css-femo2h eykyrpm0">import { useEffect, useState } from &quot;react&quot;;

export default function useClient() {
  const [isClient, setClient] = useState(false);

  useEffect(() =&gt; {
    setClient(true);
  }, []);

  return { isClient };
}
</code></pre>
<p>이를 이용하여, 아래와 같이 CSR 전까지는 react-syntax-highlighter를 적용하지 않도록 하여 에러를 해결하였다.
(가독성을 위해 일부 props는 생략하였다.)</p>
<p>Using this, I solved the errors by preventing the component from applying react-syntax-highlighter before starting CSR.
(I omitted some props for readability.)</p>
<pre><code class="language-tsx css-femo2h eykyrpm0">import { PrismLight as SyntaxHighlighter } from &quot;react-syntax-highlighter&quot;;

...

const PostView = () =&gt; (
  &lt;ReactMarkdown
    components={{
      code: MarkdownCode,
      a: MarkdownLink,
      img: MarkdownImage,
    }}
  &gt;
    ...
  &lt;/ReactMarkdown&gt;
);

...

const MarkdownCode = () =&gt; {
  const { isClient } = useClient();

  ...

  return isClient &amp;&amp; ... ? (
    &lt;SyntaxHighlighter&gt;
      ...
    &lt;/SyntaxHighlighter&gt;
  ) : (
    &lt;InlineCode&gt;
      ...
    &lt;/InlineCode&gt;
  );
};
</code></pre></div><div class="css-4osezd eykyrpm6">카테고리<!-- -->: <style data-emotion="css mq9u7p">.css-mq9u7p{-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:inherit;font-size:inherit;color:#3c4fff;}</style><a class="css-mq9u7p eykyrpm7" href="/blog/category/computer/">Computer</a></div><style data-emotion="css vd5och">.css-vd5och{margin-top:32px;margin-bottom:128px;font-size:16px;}</style><div class="css-vd5och">Loading the comments...</div><div id="disqus_thread"></div></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"key":"nextmismatch","title":"Server \u0026 client mismatch problem in Next.js","time":1663718400000,"category":"Computer","content":"이 웹사이트를 실행했을 때, 작동은 잘 되는 것 같은데 콘솔에 아래와 같은 에러 메시지들이 뜨는 문제가 있었다.\n\nWhen I run this website, it seems to work fine, but I got following error messages appearing on the console.\n\n```text\nUncaught Error: Minified React error #425; visit https://reactjs.org/docs/error-decoder.html?invariant=425 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\n\nUncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\n\nUncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\n```\n\n위 에러 메시지들에 나온 링크를 방문해보면 아래와 같은 메시지들이 나온다.\n\nIf you visit the links in these error messages, you will see the following messages.\n\n- Text content does not match server-rendered HTML.\n- Hydration failed because the initial UI does not match what was rendered on the server.\n- There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.\n\n이 웹사이트는 Next.js로 정적 사이트 생성(SSG - Static Site Generation)을 하여 만들었다.\nNext.js로 미리 생성한 HTML을 일단 유저에게 보여주고, 그 후에 React로 hydration \u0026 CSR(Client-side Rendering)을 하는 방식이다.\n따라서, 위의 메시지들은 미리 렌더링한 HTML과 클라이언트에서 렌더링한 HTML 간에 내용물이 불일치한다는 것을 의미한다.\n이 문제는 SSR 뿐만 아니라 SSR 상황에서도 동일하게 발생한다.\n\nI created this website by using SSG (Static Site Generation) with Next.js\nIt works by showing the pre-generated HTML to the user first, and performing hydration \u0026 CSR (Client-side Rendering) with React.\nTherefore, the above messages mean that there is a content mismatch between the pre-rendered HTML and the client-rendered HTML.\nThis problem can occur not only SSG but also SSR, too.\n\n원인은 두 곳에 있었다.\n하나는 페이지 상단의 시계 UI이다.\n\nThere were two reasons.\nOne is the clock UI at the top of the page.\n\n```typescript\nimport { useEffect, useState } from \"react\";\n\nexport default function useNow() {\n  const [now, setNow] = useState(new Date());\n\n  useEffect(() =\u003e {\n    const interval = setInterval(() =\u003e {\n      setNow(new Date());\n    }, 1000 * 10);\n\n    return () =\u003e {\n      clearInterval(interval);\n    };\n  }, []);\n\n  return {\n    year: now.getFullYear(),\n    month: now.getMonth() + 1,\n    monthDay: now.getDate(),\n    hour: now.getHours(),\n    minute: now.getMinutes(),\n    second: now.getSeconds(),\n  };\n}\n```\n\n시계 기능을 구현하기 위해 위와 같은 custom hook을 작성했었다.\n그런데 `const [now, setNow] = useState(new Date());`에서 `new Date()`의 값은 서버 렌더링 시와, 클라이언트 렌더링 시에 **서로 다르다**.\n이로 인하여 시계 텍스트가 두 상황에서 불일치하여 에러가 났던 것이다.\nCSR 전까지는 실제 시간을 사용하지 않고 더미 값을 쓰도록 하여 해결하였다.\n\nI wrote the above custom hook to implement the clock.\nHowever, in `const [now, setNow] = useState(new Date());`, the value of `new Date()` is **different** between server rendering and client rendering.\nThis inconsistency of the clock text caused the error.\nI solved this problem by using a dummy value until we perform CSR.\n\n다만 이러면 초반에 시간이 더미 값으로 떠서 이상해 보이는 문제가 있다.\n적절한 로딩 UI를 부여하면 좀 낫지 않을까 한다.\n\nHowever, we get a problem that the user sees a dummy value at the beginning.\nWe may fix that problem by using appropriate loading UI.\n\n```typescript\nimport { useEffect, useState } from \"react\";\n\ninterface Time {\n  year: number;\n  month: number;\n  monthDay: number;\n  hour: number;\n  minute: number;\n  second: number;\n}\n\nexport default function useNow(): Time {\n  // If we use new Date() at here, server HTML and client HTML won't match.\n  // So we don't compute date before useEffect().\n  const [now, setNow] = useState\u003cDate | null\u003e(null);\n\n  useEffect(() =\u003e {\n    setNow(new Date());\n\n    const interval = setInterval(() =\u003e {\n      setNow(new Date());\n    }, 1000 * 10);\n\n    return () =\u003e {\n      clearInterval(interval);\n    };\n  }, []);\n\n  return now === null\n    ? {\n        year: 0,\n        month: 0,\n        monthDay: 0,\n        hour: 0,\n        minute: 0,\n        second: 0,\n      }\n    : {\n        year: now.getFullYear(),\n        month: now.getMonth() + 1,\n        monthDay: now.getDate(),\n        hour: now.getHours(),\n        minute: now.getMinutes(),\n        second: now.getSeconds(),\n      };\n}\n```\n\n다른 하나는 이 글처럼 코드를 렌더링 할 때 쓰는 react-syntax-highlighter 라이브러리이다.\n해당 라이브러리는 내부적으로 [Prism.js](https://prismjs.com/)(또는 [highlight.js](https://highlightjs.org/))를 호출한다.\n이들은 코드를 읽고 **DOM을 변경**하여 코드 하이라이팅을 한다.\n이것이 mismatch를 만들어낸 것으로 추정한다.\n\n이와 같은 상황에서 특정 동작을 클라이언트에서만 하도록 하고 싶으면, `useEffect()`를 활용할 수 있다.\n`useEffect()` 안의 코드는 항상 **클라이언트에서만 실행**된다.\n`useEffect()`가 처음 불리는 시점은 컴포넌트가 마운트된 이후, 즉 DOM이 생성된 이후이기 때문이다.\n\nThe other is the react-syntax-highlighter library used when rendering code like this article.\nThe library calls [Prism.js](https://prismjs.com/) (or [highlight.js](https://highlightjs.org/)) internally.\nThey read the code and **change the DOM** to highlight the code.\nIt seems that that behavior created mismatches.\n\nIn such a situation, if you want to make certain actions executed only for the client, you can use `useEffect()`.\nCode in `useEffect()` is always executed **only on the client**.\nThis is because the first time `useEffect()` is called is after the component is mounted i.e after the DOM is created.\n\n우선 아래와 같은 custom hook을 하나 만들었다.\n`isClient`는 클라이언트에서만 true이 된다.\n\nI created the following custom hook first.\n`isClient` can be true only on the client.\n\n```typescript\nimport { useEffect, useState } from \"react\";\n\nexport default function useClient() {\n  const [isClient, setClient] = useState(false);\n\n  useEffect(() =\u003e {\n    setClient(true);\n  }, []);\n\n  return { isClient };\n}\n```\n\n이를 이용하여, 아래와 같이 CSR 전까지는 react-syntax-highlighter를 적용하지 않도록 하여 에러를 해결하였다.\n(가독성을 위해 일부 props는 생략하였다.)\n\nUsing this, I solved the errors by preventing the component from applying react-syntax-highlighter before starting CSR.\n(I omitted some props for readability.)\n\n```tsx\nimport { PrismLight as SyntaxHighlighter } from \"react-syntax-highlighter\";\n\n...\n\nconst PostView = () =\u003e (\n  \u003cReactMarkdown\n    components={{\n      code: MarkdownCode,\n      a: MarkdownLink,\n      img: MarkdownImage,\n    }}\n  \u003e\n    ...\n  \u003c/ReactMarkdown\u003e\n);\n\n...\n\nconst MarkdownCode = () =\u003e {\n  const { isClient } = useClient();\n\n  ...\n\n  return isClient \u0026\u0026 ... ? (\n    \u003cSyntaxHighlighter\u003e\n      ...\n    \u003c/SyntaxHighlighter\u003e\n  ) : (\n    \u003cInlineCode\u003e\n      ...\n    \u003c/InlineCode\u003e\n  );\n};\n```\n"}},"__N_SSG":true},"page":"/blog/post/[key]","query":{"key":"nextmismatch"},"buildId":"YFQecxITs5IjSo3NXKcxk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>