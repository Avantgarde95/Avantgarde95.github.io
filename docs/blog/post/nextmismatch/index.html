<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"/><link href="https://fonts.cdnfonts.com/css/sf-mono" rel="stylesheet"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-87b3a303122f2f0d.js" defer=""></script><script src="/_next/static/chunks/framework-a95b3927b35070c8.js" defer=""></script><script src="/_next/static/chunks/main-396d5c49e8a59a09.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ca9b7cef2b56fb46.js" defer=""></script><script src="/_next/static/chunks/14-c92742101a4cef76.js" defer=""></script><script src="/_next/static/chunks/800-ce247f5639bf3d5d.js" defer=""></script><script src="/_next/static/chunks/pages/blog/post/%5Bkey%5D-17208e01f08aa87e.js" defer=""></script><script src="/_next/static/46Q2V22kQ0uTuCLZsGzYc/_buildManifest.js" defer=""></script><script src="/_next/static/46Q2V22kQ0uTuCLZsGzYc/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global iftqeq">html{width:100%;height:100%;margin:0;padding:0;font-family:"Pretendard",sans-serif;font-size:62.5%;}body{width:100%;height:100%;margin:0;padding:0;}#__next{width:100%;height:100%;}</style><style data-emotion="css 11h3v09">.css-11h3v09{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;width:100%;height:100%;color:#1f1f1f;background-color:#ffffff;}</style><div class="css-11h3v09 e12ob6f70"><style data-emotion="css ei8rx5">.css-ei8rx5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;max-width:1000px;}</style><div class="css-ei8rx5 e12ob6f71"><style data-emotion="css 1n0l3qb">.css-1n0l3qb{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;width:100%;padding:22px 24px 10px 24px;}</style><div class="css-1n0l3qb e1dz70rv0"><style data-emotion="css 1bnw8zv">.css-1bnw8zv{font-size:14px;font-weight:500;}</style><div class="css-1bnw8zv">00<!-- -->:<!-- -->00</div><style data-emotion="css 18a0bh6">.css-18a0bh6{margin-left:auto;}</style><style data-emotion="css 128qw07">.css-128qw07{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:17px;height:17px;margin-left:auto;}</style><div class="css-128qw07 e1dz70rv1"><svg width="17" height="17" fill="none" xmlns="http://www.w3.org/2000/svg"><path opacity="0.1" d="M8.5 1.417c-3.4 0-6.375 1.487-8.5 3.825l8.5 10.341L17 5.242c-2.125-2.338-5.1-3.825-8.5-3.825Z" fill="#1F1F1F"></path></svg></div><style data-emotion="css 4iefm">.css-4iefm{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:17px;height:17px;}</style><div class="css-4iefm e1dz70rv1"><svg width="17" height="17" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.583 1.417 1.417 15.583h14.166V1.417Z" fill="#1F1F1F"></path></svg></div><div class="css-4iefm e1dz70rv1"><svg width="8" height="15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 0h-3v1.5H1c-.552 0-1 .504-1 1.125v11.25C0 14.496.448 15 1 15h6c.552 0 1-.504 1-1.125V2.625C8 2.004 7.552 1.5 7 1.5H5.5V0Z" fill="#1F1F1F" fill-opacity="0.3"></path><path d="M0 8v5.95C0 14.53.448 15 1 15h6c.552 0 1-.47 1-1.05V8H0Z" fill="#1F1F1F"></path></svg></div></div><style data-emotion="css 1plrt3">.css-1plrt3{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;width:100%;padding:18px 20px;}</style><header class="css-1plrt3 ecceavf0"><style data-emotion="css 1j4ubxs">.css-1j4ubxs{cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}</style><style data-emotion="css hxj3u3">.css-hxj3u3{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}.css-hxj3u3:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-hxj3u3:hover{background-color:transparent;}}.css-hxj3u3.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css pj48ct">.css-pj48ct{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;min-width:0;min-height:0;margin-right:auto;}.css-pj48ct::-moz-focus-inner{border-style:none;}.css-pj48ct.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-pj48ct{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-pj48ct:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-pj48ct:hover{background-color:transparent;}}.css-pj48ct.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium css-pj48ct" tabindex="0" type="button"><svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18M3 12h18M3 6h18" stroke="#1F1F1F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><style data-emotion="css a3xyjy">.css-a3xyjy{z-index:1200;}</style><style data-emotion="css 1j2lmr9 animation-jotq25">.css-1j2lmr9{margin:0;padding:0;text-align:center;-webkit-flex:1;-ms-flex:1;flex:1;font-size:21px;font-weight:700;opacity:0;-webkit-animation:animation-jotq25 0.5s forwards;animation:animation-jotq25 0.5s forwards;}@-webkit-keyframes animation-jotq25{100%{opacity:1;}}@keyframes animation-jotq25{100%{opacity:1;}}</style><h1 class="css-1j2lmr9 ecceavf1">블로그</h1><style data-emotion="css wakbyj">.css-wakbyj{cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}</style><style data-emotion="css 1c6gj7b">.css-1c6gj7b{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}.css-1c6gj7b:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-1c6gj7b:hover{background-color:transparent;}}.css-1c6gj7b.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css 1va6h6f">.css-1va6h6f{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;cursor:pointer;box-sizing:border-box;border:0;padding:0;color:inherit;background-color:transparent;font-family:inherit;font-size:inherit;width:24px;height:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;min-width:0;min-height:0;margin-left:auto;}.css-1va6h6f::-moz-focus-inner{border-style:none;}.css-1va6h6f.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1va6h6f{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1va6h6f:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-1va6h6f:hover{background-color:transparent;}}.css-1va6h6f.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium css-1va6h6f" tabindex="0" type="button"><style data-emotion="css 1i0bw9d">.css-1i0bw9d{font-size:21px;line-height:21px;opacity:1;-webkit-transition:opacity 1s,font-size 0.3s,line-height 0.3s;transition:opacity 1s,font-size 0.3s,line-height 0.3s;}</style><span class="css-1i0bw9d">가</span><style data-emotion="css bah3n2">.css-bah3n2{font-size:12px;line-height:12px;opacity:0.5;-webkit-transition:opacity 1s,font-size 0.3s,line-height 0.3s;transition:opacity 1s,font-size 0.3s,line-height 0.3s;}</style><span class="css-bah3n2">A</span></button></header><style data-emotion="css 1ej2pvw">.css-1ej2pvw{overflow-y:auto;width:100%;-webkit-flex:1;-ms-flex:1;flex:1;}</style><main class="css-1ej2pvw e12ob6f72"><style data-emotion="css 1jldanx">.css-1jldanx{box-sizing:border-box;width:100%;padding:0 21px;}</style><div class="css-1jldanx e13n4kg82"><style data-emotion="css 1rr6krv">.css-1rr6krv{margin-bottom:2px;font-size:20px;font-weight:bold;}</style><div class="css-1rr6krv e13n4kg83">Server &amp; client mismatch problem in Next.js</div><style data-emotion="css 4osezd">.css-4osezd{margin-bottom:16px;font-size:16px;}</style><div class="css-4osezd e13n4kg84">2022-09-21</div><style data-emotion="css yar54t">.css-yar54t{word-break:break-all;width:100%;margin-bottom:8px;font-size:16px;border-top:1px solid #818181;border-bottom:1px solid #818181;}.css-yar54t h1{font-size:20px;}.css-yar54t h2{font-size:18px;}.css-yar54t h3{font-size:16px;}.css-yar54t ul{padding-left:24px;}.css-yar54t a{cursor:pointer;font-weight:normal;color:#3c4fff;}.css-yar54t table{box-sizing:border-box;border-collapse:collapse;border:1px solid #818181;}.css-yar54t table th,.css-yar54t table td{box-sizing:border-box;padding:8px;border:1px solid #818181;}.css-yar54t code{font-family:"SF Mono",monospace!important;}</style><div class="css-yar54t e13n4kg85"><p>이 웹사이트를 실행했을 때, 작동은 잘 되는 것 같은데 콘솔에 아래와 같은 에러 메시지들이 뜨는 문제가 있었다.</p>
<p>When I run this website, it seems to work fine, but I got following error messages appearing on the console.</p>
<pre><style data-emotion="css femo2h">.css-femo2h{box-sizing:border-box;vertical-align:middle;font-size:13px;padding:0 2px;line-height:16px;background-color:rgba(232,232,232,0.7);}</style><code class="language-text css-femo2h e13n4kg80">Uncaught Error: Minified React error #425; visit https://reactjs.org/docs/error-decoder.html?invariant=425 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.

Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.

Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
</code></pre>
<p>위 에러 메시지들에 나온 링크를 방문해보면 아래와 같은 메시지들이 나온다.</p>
<p>If you visit the links in these error messages, you will see the following messages.</p>
<ul>
<li>Text content does not match server-rendered HTML.</li>
<li>Hydration failed because the initial UI does not match what was rendered on the server.</li>
<li>There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.</li>
</ul>
<p>이 웹사이트는 Next.js로 정적 사이트 생성(SSG - Static Site Generation)을 하여 만들었다.
Next.js로 미리 생성한 HTML을 일단 유저에게 보여주고, 그 후에 React로 hydration &amp; CSR(Client-side Rendering)을 하는 방식이다.
따라서, 위의 메시지들은 미리 렌더링한 HTML과 클라이언트에서 렌더링한 HTML 간에 내용물이 불일치한다는 것을 의미한다.
이 문제는 SSR 뿐만 아니라 SSR 상황에서도 동일하게 발생한다.</p>
<p>I created this website by using SSG (Static Site Generation) with Next.js
It works by showing the pre-generated HTML to the user first, and performing hydration &amp; CSR (Client-side Rendering) with React.
Therefore, the above messages mean that there is a content mismatch between the pre-rendered HTML and the client-rendered HTML.
This problem can occur not only SSG but also SSR, too.</p>
<p>원인은 두 곳에 있었다.
하나는 페이지 상단의 시계 UI이다.</p>
<p>There were two reasons.
One is the clock UI at the top of the page.</p>
<pre><code class="language-typescript css-femo2h e13n4kg80">import { useEffect, useState } from &quot;react&quot;;

export default function useNow() {
  const [now, setNow] = useState(new Date());

  useEffect(() =&gt; {
    const interval = setInterval(() =&gt; {
      setNow(new Date());
    }, 1000 * 10);

    return () =&gt; {
      clearInterval(interval);
    };
  }, []);

  return {
    year: now.getFullYear(),
    month: now.getMonth() + 1,
    monthDay: now.getDate(),
    hour: now.getHours(),
    minute: now.getMinutes(),
    second: now.getSeconds(),
  };
}
</code></pre>
<p>시계 기능을 구현하기 위해 위와 같은 custom hook을 작성했었다.
그런데 <code class="css-femo2h e13n4kg80">const [now, setNow] = useState(new Date());</code>에서 <code class="css-femo2h e13n4kg80">new Date()</code>의 값은 서버 렌더링 시와, 클라이언트 렌더링 시에 <strong>서로 다르다</strong>.
이로 인하여 시계 텍스트가 두 상황에서 불일치하여 에러가 났던 것이다.
CSR 전까지는 실제 시간을 사용하지 않고 더미 값을 쓰도록 하여 해결하였다.</p>
<p>I wrote the above custom hook to implement the clock.
However, in <code class="css-femo2h e13n4kg80">const [now, setNow] = useState(new Date());</code>, the value of <code class="css-femo2h e13n4kg80">new Date()</code> is <strong>different</strong> between server rendering and client rendering.
This inconsistency of the clock text caused the error.
I solved this problem by using a dummy value until we perform CSR.</p>
<p>다만 이러면 초반에 시간이 더미 값으로 떠서 이상해 보이는 문제가 있다.
적절한 로딩 UI를 부여하면 좀 낫지 않을까 한다.</p>
<p>However, we get a problem that the user sees a dummy value at the beginning.
We may fix that problem by using appropriate loading UI.</p>
<pre><code class="language-typescript css-femo2h e13n4kg80">import { useEffect, useState } from &quot;react&quot;;

interface Time {
  year: number;
  month: number;
  monthDay: number;
  hour: number;
  minute: number;
  second: number;
}

export default function useNow(): Time {
  // If we use new Date() at here, server HTML and client HTML won&#x27;t match.
  // So we don&#x27;t compute date before useEffect().
  const [now, setNow] = useState&lt;Date | null&gt;(null);

  useEffect(() =&gt; {
    setNow(new Date());

    const interval = setInterval(() =&gt; {
      setNow(new Date());
    }, 1000 * 10);

    return () =&gt; {
      clearInterval(interval);
    };
  }, []);

  return now === null
    ? {
        year: 0,
        month: 0,
        monthDay: 0,
        hour: 0,
        minute: 0,
        second: 0,
      }
    : {
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        monthDay: now.getDate(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        second: now.getSeconds(),
      };
}
</code></pre>
<p>다른 하나는 이 글처럼 코드를 렌더링 할 때 쓰는 react-syntax-highlighter 라이브러리이다.
해당 라이브러리는 내부적으로 <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">Prism.js</a>(또는 <a target="_blank" rel="noreferrer noopener" href="https://highlightjs.org/">highlight.js</a>)를 호출한다.
이들은 코드를 읽고 <strong>DOM을 변경</strong>하여 코드 하이라이팅을 한다.
이것이 mismatch를 만들어낸 것으로 추정한다.</p>
<p>이와 같은 상황에서 특정 동작을 클라이언트에서만 하도록 하고 싶으면, <code class="css-femo2h e13n4kg80">useEffect()</code>를 활용할 수 있다.
<code class="css-femo2h e13n4kg80">useEffect()</code> 안의 코드는 항상 <strong>클라이언트에서만 실행</strong>된다.
<code class="css-femo2h e13n4kg80">useEffect()</code>가 처음 불리는 시점은 컴포넌트가 마운트된 이후, 즉 DOM이 생성된 이후이기 때문이다.</p>
<p>The other is the react-syntax-highlighter library used when rendering code like this article.
The library calls <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">Prism.js</a> (or <a target="_blank" rel="noreferrer noopener" href="https://highlightjs.org/">highlight.js</a>) internally.
They read the code and <strong>change the DOM</strong> to highlight the code.
It seems that that behavior created mismatches.</p>
<p>In such a situation, if you want to make certain actions executed only for the client, you can use <code class="css-femo2h e13n4kg80">useEffect()</code>.
Code in <code class="css-femo2h e13n4kg80">useEffect()</code> is always executed <strong>only on the client</strong>.
This is because the first time <code class="css-femo2h e13n4kg80">useEffect()</code> is called is after the component is mounted i.e after the DOM is created.</p>
<p>우선 아래와 같은 custom hook을 하나 만들었다.
<code class="css-femo2h e13n4kg80">isClient</code>는 클라이언트에서만 true이 된다.</p>
<p>I created the following custom hook first.
<code class="css-femo2h e13n4kg80">isClient</code> can be true only on the client.</p>
<pre><code class="language-typescript css-femo2h e13n4kg80">import { useEffect, useState } from &quot;react&quot;;

export default function useClient() {
  const [isClient, setClient] = useState(false);

  useEffect(() =&gt; {
    setClient(true);
  }, []);

  return { isClient };
}
</code></pre>
<p>이를 이용하여, 아래와 같이 CSR 전까지는 react-syntax-highlighter를 적용하지 않도록 하여 에러를 해결하였다.
(가독성을 위해 일부 props는 생략하였다.)</p>
<p>Using this, I solved the errors by preventing the component from applying react-syntax-highlighter before starting CSR.
(I omitted some props for readability.)</p>
<pre><code class="language-tsx css-femo2h e13n4kg80">import { PrismLight as SyntaxHighlighter } from &quot;react-syntax-highlighter&quot;;

...

const PostView = () =&gt; (
  &lt;ReactMarkdown
    components={{
      code: MarkdownCode,
      a: MarkdownLink,
      img: MarkdownImage,
    }}
  &gt;
    ...
  &lt;/ReactMarkdown&gt;
);

...

const MarkdownCode = () =&gt; {
  const { isClient } = useClient();

  ...

  return isClient &amp;&amp; ... ? (
    &lt;SyntaxHighlighter&gt;
      ...
    &lt;/SyntaxHighlighter&gt;
  ) : (
    &lt;InlineCode&gt;
      ...
    &lt;/InlineCode&gt;
  );
};
</code></pre></div><div class="css-4osezd e13n4kg86">카테고리<!-- -->: <style data-emotion="css 1tpbm6x">.css-1tpbm6x{-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:inherit;font-size:inherit;color:#3c4fff;}</style><a class="css-1tpbm6x e13n4kg87" href="/blog/category/computer/">Computer</a></div><style data-emotion="css vd5och">.css-vd5och{margin-top:32px;margin-bottom:128px;font-size:16px;}</style><div class="css-vd5och">Loading the comments...</div><div id="disqus_thread"></div></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"key":"nextmismatch","title":"Server \u0026 client mismatch problem in Next.js","time":1663718400000,"category":"Computer","content":"이 웹사이트를 실행했을 때, 작동은 잘 되는 것 같은데 콘솔에 아래와 같은 에러 메시지들이 뜨는 문제가 있었다.\r\n\r\nWhen I run this website, it seems to work fine, but I got following error messages appearing on the console.\r\n\r\n```text\r\nUncaught Error: Minified React error #425; visit https://reactjs.org/docs/error-decoder.html?invariant=425 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\r\n\r\nUncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\r\n\r\nUncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.\r\n```\r\n\r\n위 에러 메시지들에 나온 링크를 방문해보면 아래와 같은 메시지들이 나온다.\r\n\r\nIf you visit the links in these error messages, you will see the following messages.\r\n\r\n- Text content does not match server-rendered HTML.\r\n- Hydration failed because the initial UI does not match what was rendered on the server.\r\n- There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.\r\n\r\n이 웹사이트는 Next.js로 정적 사이트 생성(SSG - Static Site Generation)을 하여 만들었다.\r\nNext.js로 미리 생성한 HTML을 일단 유저에게 보여주고, 그 후에 React로 hydration \u0026 CSR(Client-side Rendering)을 하는 방식이다.\r\n따라서, 위의 메시지들은 미리 렌더링한 HTML과 클라이언트에서 렌더링한 HTML 간에 내용물이 불일치한다는 것을 의미한다.\r\n이 문제는 SSR 뿐만 아니라 SSR 상황에서도 동일하게 발생한다.\r\n\r\nI created this website by using SSG (Static Site Generation) with Next.js\r\nIt works by showing the pre-generated HTML to the user first, and performing hydration \u0026 CSR (Client-side Rendering) with React.\r\nTherefore, the above messages mean that there is a content mismatch between the pre-rendered HTML and the client-rendered HTML.\r\nThis problem can occur not only SSG but also SSR, too.\r\n\r\n원인은 두 곳에 있었다.\r\n하나는 페이지 상단의 시계 UI이다.\r\n\r\nThere were two reasons.\r\nOne is the clock UI at the top of the page.\r\n\r\n```typescript\r\nimport { useEffect, useState } from \"react\";\r\n\r\nexport default function useNow() {\r\n  const [now, setNow] = useState(new Date());\r\n\r\n  useEffect(() =\u003e {\r\n    const interval = setInterval(() =\u003e {\r\n      setNow(new Date());\r\n    }, 1000 * 10);\r\n\r\n    return () =\u003e {\r\n      clearInterval(interval);\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    year: now.getFullYear(),\r\n    month: now.getMonth() + 1,\r\n    monthDay: now.getDate(),\r\n    hour: now.getHours(),\r\n    minute: now.getMinutes(),\r\n    second: now.getSeconds(),\r\n  };\r\n}\r\n```\r\n\r\n시계 기능을 구현하기 위해 위와 같은 custom hook을 작성했었다.\r\n그런데 `const [now, setNow] = useState(new Date());`에서 `new Date()`의 값은 서버 렌더링 시와, 클라이언트 렌더링 시에 **서로 다르다**.\r\n이로 인하여 시계 텍스트가 두 상황에서 불일치하여 에러가 났던 것이다.\r\nCSR 전까지는 실제 시간을 사용하지 않고 더미 값을 쓰도록 하여 해결하였다.\r\n\r\nI wrote the above custom hook to implement the clock.\r\nHowever, in `const [now, setNow] = useState(new Date());`, the value of `new Date()` is **different** between server rendering and client rendering.\r\nThis inconsistency of the clock text caused the error.\r\nI solved this problem by using a dummy value until we perform CSR.\r\n\r\n다만 이러면 초반에 시간이 더미 값으로 떠서 이상해 보이는 문제가 있다.\r\n적절한 로딩 UI를 부여하면 좀 낫지 않을까 한다.\r\n\r\nHowever, we get a problem that the user sees a dummy value at the beginning.\r\nWe may fix that problem by using appropriate loading UI.\r\n\r\n```typescript\r\nimport { useEffect, useState } from \"react\";\r\n\r\ninterface Time {\r\n  year: number;\r\n  month: number;\r\n  monthDay: number;\r\n  hour: number;\r\n  minute: number;\r\n  second: number;\r\n}\r\n\r\nexport default function useNow(): Time {\r\n  // If we use new Date() at here, server HTML and client HTML won't match.\r\n  // So we don't compute date before useEffect().\r\n  const [now, setNow] = useState\u003cDate | null\u003e(null);\r\n\r\n  useEffect(() =\u003e {\r\n    setNow(new Date());\r\n\r\n    const interval = setInterval(() =\u003e {\r\n      setNow(new Date());\r\n    }, 1000 * 10);\r\n\r\n    return () =\u003e {\r\n      clearInterval(interval);\r\n    };\r\n  }, []);\r\n\r\n  return now === null\r\n    ? {\r\n        year: 0,\r\n        month: 0,\r\n        monthDay: 0,\r\n        hour: 0,\r\n        minute: 0,\r\n        second: 0,\r\n      }\r\n    : {\r\n        year: now.getFullYear(),\r\n        month: now.getMonth() + 1,\r\n        monthDay: now.getDate(),\r\n        hour: now.getHours(),\r\n        minute: now.getMinutes(),\r\n        second: now.getSeconds(),\r\n      };\r\n}\r\n```\r\n\r\n다른 하나는 이 글처럼 코드를 렌더링 할 때 쓰는 react-syntax-highlighter 라이브러리이다.\r\n해당 라이브러리는 내부적으로 [Prism.js](https://prismjs.com/)(또는 [highlight.js](https://highlightjs.org/))를 호출한다.\r\n이들은 코드를 읽고 **DOM을 변경**하여 코드 하이라이팅을 한다.\r\n이것이 mismatch를 만들어낸 것으로 추정한다.\r\n\r\n이와 같은 상황에서 특정 동작을 클라이언트에서만 하도록 하고 싶으면, `useEffect()`를 활용할 수 있다.\r\n`useEffect()` 안의 코드는 항상 **클라이언트에서만 실행**된다.\r\n`useEffect()`가 처음 불리는 시점은 컴포넌트가 마운트된 이후, 즉 DOM이 생성된 이후이기 때문이다.\r\n\r\nThe other is the react-syntax-highlighter library used when rendering code like this article.\r\nThe library calls [Prism.js](https://prismjs.com/) (or [highlight.js](https://highlightjs.org/)) internally.\r\nThey read the code and **change the DOM** to highlight the code.\r\nIt seems that that behavior created mismatches.\r\n\r\nIn such a situation, if you want to make certain actions executed only for the client, you can use `useEffect()`.\r\nCode in `useEffect()` is always executed **only on the client**.\r\nThis is because the first time `useEffect()` is called is after the component is mounted i.e after the DOM is created.\r\n\r\n우선 아래와 같은 custom hook을 하나 만들었다.\r\n`isClient`는 클라이언트에서만 true이 된다.\r\n\r\nI created the following custom hook first.\r\n`isClient` can be true only on the client.\r\n\r\n```typescript\r\nimport { useEffect, useState } from \"react\";\r\n\r\nexport default function useClient() {\r\n  const [isClient, setClient] = useState(false);\r\n\r\n  useEffect(() =\u003e {\r\n    setClient(true);\r\n  }, []);\r\n\r\n  return { isClient };\r\n}\r\n```\r\n\r\n이를 이용하여, 아래와 같이 CSR 전까지는 react-syntax-highlighter를 적용하지 않도록 하여 에러를 해결하였다.\r\n(가독성을 위해 일부 props는 생략하였다.)\r\n\r\nUsing this, I solved the errors by preventing the component from applying react-syntax-highlighter before starting CSR.\r\n(I omitted some props for readability.)\r\n\r\n```tsx\r\nimport { PrismLight as SyntaxHighlighter } from \"react-syntax-highlighter\";\r\n\r\n...\r\n\r\nconst PostView = () =\u003e (\r\n  \u003cReactMarkdown\r\n    components={{\r\n      code: MarkdownCode,\r\n      a: MarkdownLink,\r\n      img: MarkdownImage,\r\n    }}\r\n  \u003e\r\n    ...\r\n  \u003c/ReactMarkdown\u003e\r\n);\r\n\r\n...\r\n\r\nconst MarkdownCode = () =\u003e {\r\n  const { isClient } = useClient();\r\n\r\n  ...\r\n\r\n  return isClient \u0026\u0026 ... ? (\r\n    \u003cSyntaxHighlighter\u003e\r\n      ...\r\n    \u003c/SyntaxHighlighter\u003e\r\n  ) : (\r\n    \u003cInlineCode\u003e\r\n      ...\r\n    \u003c/InlineCode\u003e\r\n  );\r\n};\r\n```\r\n"}},"__N_SSG":true},"page":"/blog/post/[key]","query":{"key":"nextmismatch"},"buildId":"46Q2V22kQ0uTuCLZsGzYc","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>